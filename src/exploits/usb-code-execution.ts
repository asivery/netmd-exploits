import JSBI from 'jsbi';
import { formatQuery, patch, scanQuery } from 'netmd-js';
import { Exploit } from '../exploit';
import { formatUIntQuery } from '../utils';

export class USBCodeExecution extends Exploit {
    public static _name = 'USBCodeExecution';

    public _policies = {
        stateManagerUnpatchLegal: true,
    };

    protected getPropertyStore() {
        return {
            onePatchAddress: {
                'S1.600': 0x0000e69c,
                'S1.500': 0x0000e538,
                'S1.400': 0x0000e4c4,
                'S1.300': 0x0000daa8,
                'S1.200': 0x0000d834,
                'S1.100': 0x0000d784,
                'S1.000': 0x0000e784,

                'R1.000': 0x00056228,
                'R1.100': 0x00056aac,
                'R1.200': 0x000577f8,
                'R1.300': 0x00057b48,
                'R1.400': 0x00057be8,

                'Hr1.000': 0x000989f0,
                'Hn1.100': 0x0009d364,
                'Hn1.200': 0x0009d060,
                
                'Hx1.0A0': 0x0007db00,
                'Hx1.090': 0x0007daf4,
                'Hx1.070': 0x0007da88,
            },
            onePatchValue: {
                'S1.600,S1.500,S1.400,S1.300,S1.200,S1.100,S1.000': new Uint8Array([0x13, 0x48, 0x00, 0x47]),
                'R1.400,R1.300,R1.200,R1.100,R1.000': new Uint8Array([0x1a, 0x48, 0x00, 0x47]),
                'Hr1.000': new Uint8Array([0x10, 0x48, 0x00, 0x47]),
                'Hn1.200,Hn1.100,Hx1.0A0,Hx1.090,Hx1.070': new Uint8Array([0x12, 0x48, 0x00, 0x47]),
            },
            twoPatchAddress1: {},
            twoPatchValue1: {},
            twoPatchAddress2: {},
            twoPatchValue2: {},

            command: {
                'Hr*,Hn*,Hx*': 0xd2,
                'S*': 0xd2,
                'R*': 0xd3,
            },
        };
    }

    public async init() {
        await super.init();
        // Check if the device has already been patched (f. ex. hard-patch)
        const reply = await this.execute(formatUIntQuery('0100a0e30000cfe51eff2fe1 00'));
        const resp = scanQuery(reply, '0100a0e30000cfe51eff2fe1 %b');
        if (JSBI.toNumber(resp[0] as JSBI) === 0) {
            if (this.getPropertyOrNull('onePatchAddress') !== null) {
                const [addr, val] = this.getProperties('onePatchAddress', 'onePatchValue');
                await this.stateManager.patch(addr, val);
            } else {
                // Fallback to two-patch system
                const [addr1, val1, addr2, val2] = this.getProperties(
                    'twoPatchAddress1',
                    'twoPatchValue1',
                    'twoPatchAddress2',
                    'twoPatchValue2'
                );
                await this.stateManager.patch(addr1, val1);
                await this.stateManager.patch(addr2, val2);
            }
        }
    }

    public async execute(code: Uint8Array, length?: number) {
        const query = formatQuery('00 18%b ff %*', this.getProperty('command'), code);
        // Use iface.netMd to talk to the interface directly
        // arbitrary code execution still returns 'Not Implemented', and would crash
        // netmd-js's NetMDInterface with NotImplementedError, this is a workaround.
        await this.iface.netMd.sendCommand(query);
        const { data } = await this.iface.netMd.readReply(length ?? query.byteLength + 1);
        const buffer = data!.buffer;
        const [newCode] = scanQuery(buffer, '08 18%? ff %*');
        return newCode as Uint8Array;
    }
}
